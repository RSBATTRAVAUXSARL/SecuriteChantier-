<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Safety Tap ‚Äì Chantier Pixel</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#0b1020;
  overflow:hidden;
}
canvas{
  width:100vw;
  height:100vh;
  display:block;
  image-rendering:pixelated;
  image-rendering:crisp-edges;
  touch-action:none;
}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* ================== CANVAS ================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const BASE_W=360, BASE_H=640;
const DPR=window.devicePixelRatio||1;
canvas.width=BASE_W*DPR;
canvas.height=BASE_H*DPR;
ctx.setTransform(DPR,0,0,DPR,0,0);

/* ================== GAME STATE ================== */
let entities=[], pops=[];
let score=0, combo=0, timer=60;
let last=performance.now();
let spawnAcc=0;
let freezeUntil=0;
let gameOver=false;
let showRulesTime=5;

/* ================== HELPERS ================== */
const rand=(a,b)=>a+Math.random()*(b-a);

/* ================== RANK ================== */
function getRank(s){
  if(s>=500) return 'S';
  if(s>=400) return 'A';
  if(s>=300) return 'B';
  if(s>=200) return 'C';
  if(s>=100) return 'D';
  return 'F';
}

/* ================== SPAWN ================== */
function laneY(){ return Math.random()<0.5 ? 380 : 440; }

function spawnWorker(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'worker',
    x:dir>0?-40:BASE_W+40,
    y:laneY(),
    w:28,h:36,
    dir,
    speed:rand(45,80),
    hasHelmet:Math.random()>0.4,
    golden:Math.random()<0.06,
    frame:Math.random()*Math.PI*2
  });
}

function spawnDog(){
  // CHIEN TOUJOURS EN CONTRE-SENS
  const dir = -1; // gauche ‚Üí droite = -1 (fixe)
  entities.push({
    kind:'dog',
    x:BASE_W+70,
    y:laneY()+12,
    w:48,h:26,
    dir,
    speed:130,
    frame:Math.random()*Math.PI*2
  });
}

function spawnStop(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'stop',
    x:dir>0?-30:BASE_W+30,
    y:laneY()-40,
    w:24,h:32,
    dir,
    speed:50
  });
}

/* ================== INPUT ================== */
canvas.addEventListener('pointerdown',e=>{
  if(gameOver) return;

  const r=canvas.getBoundingClientRect();
  const px=(e.clientX-r.left)/r.width*BASE_W;
  const py=(e.clientY-r.top)/r.height*BASE_H;

  for(let i=entities.length-1;i>=0;i--){
    const en=entities[i];
    const m=14;
    if(px>=en.x-m&&px<=en.x+en.w+m &&
       py>=en.y-m&&py<=en.y+en.h+m){

      if(en.kind==='worker'){
        if(en.hasHelmet){
          score=Math.max(0,score-20);
          combo=0;
          pops.push({x:px,y:py,t:0,text:'‚ùå -20',c:'#ff6b6b'});
        }else{
          const pts=en.golden?100:10+combo*2;
          score+=pts;
          combo++;
          pops.push({x:px,y:py,t:0,text:'+'+pts,c:'#7CFF9A'});
        }
      }

      if(en.kind==='dog'){
        score=Math.max(0,score-50);
        combo=0;
        pops.push({x:px,y:py,t:0,text:'üê∂ -50',c:'#ff4d4d'});
      }

      if(en.kind==='stop'){
        freezeUntil=performance.now()+2000;
        pops.push({x:px,y:py,t:0,text:'üõë FREEZE',c:'#7fd1ff'});
      }

      entities.splice(i,1);
      return;
    }
  }
});

/* ================== UPDATE ================== */
function update(dt){
  if(gameOver) return;

  timer=Math.max(0,timer-dt);
  if(timer===0){ gameOver=true; return; }

  showRulesTime=Math.max(0,showRulesTime-dt);

  spawnAcc+=dt*(1+Math.min(1,(60-timer)/30));
  while(spawnAcc>1){
    spawnAcc--;
    const r=Math.random();
    if(r<0.15) spawnDog();        // chien
    else if(r<0.20) spawnStop();  // bonus RARE
    else spawnWorker();           // majorit√© ouvriers
  }

  const frozen=performance.now()<freezeUntil;

  for(let i=entities.length-1;i>=0;i--){
    const e=entities[i];
    if(!frozen){
      e.x+=e.dir*e.speed*dt;
      if(e.frame!=null) e.frame+=dt*12;
    }
    if(e.x<-120||e.x>BASE_W+120){
      if(e.kind==='worker'&&!e.hasHelmet){
        score=Math.max(0,score-5);
        combo=0;
      }
      entities.splice(i,1);
    }
  }

  for(let i=pops.length-1;i>=0;i--){
    pops[i].t+=dt;
    pops[i].y-=22*dt;
    if(pops[i].t>1) pops.splice(i,1);
  }
}

/* ================== DRAW ENTITIES ================== */
// (ouvrier + chien identiques √† ta version pr√©c√©dente, inchang√©s)


<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Safety Tap ‚Äì Chantier Pixel</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#0b1020;
  overflow:hidden;
}
canvas{
  width:100vw;
  height:100vh;
  display:block;
  image-rendering:pixelated;
  image-rendering:crisp-edges;
  touch-action:none;
}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* ================== CANVAS ================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const BASE_W=360, BASE_H=640;
const DPR=window.devicePixelRatio||1;

canvas.width=BASE_W*DPR;
canvas.height=BASE_H*DPR;
ctx.setTransform(DPR,0,0,DPR,0,0);

/* ================== GAME STATE ================== */
let entities=[], pops=[];
let score=0, combo=0, timer=60;
let last=performance.now();
let spawnAcc=0;
let freezeUntil=0;
let gameOver=false;

/* ================== HELPERS ================== */
const rand=(a,b)=>a+Math.random()*(b-a);

/* ================== RANK ================== */
function getRank(score){
  if(score>=500) return 'S';
  if(score>=400) return 'A';
  if(score>=300) return 'B';
  if(score>=200) return 'C';
  if(score>=100) return 'D';
  return 'F';
}

/* ================== SPAWN ================== */
function laneY(){ return Math.random()<0.5 ? 380 : 440; }

function spawnWorker(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'worker',
    x:dir>0?-40:BASE_W+40,
    y:laneY(),
    w:28,h:36,
    dir,
    speed:rand(40,80),
    hasHelmet:Math.random()>0.4,
    golden:Math.random()<0.06,
    frame:Math.random()*Math.PI*2
  });
}

function spawnDog(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'dog',
    x:dir>0?-50:BASE_W+50,
    y:laneY()+10,
    w:40,h:22,
    dir,
    speed:90
  });
}

function spawnStop(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'stop',
    x:dir>0?-30:BASE_W+30,
    y:laneY()-40,
    w:24,h:32,
    dir,
    speed:50
  });
}

/* ================== INPUT ================== */
canvas.addEventListener('pointerdown',e=>{
  if(gameOver) return;
  const r=canvas.getBoundingClientRect();
  const px=(e.clientX-r.left)/r.width*BASE_W;
  const py=(e.clientY-r.top)/r.height*BASE_H;

  for(let i=entities.length-1;i>=0;i--){
    const en=entities[i];
    const m=14;
    if(px>=en.x-m&&px<=en.x+en.w+m&&
       py>=en.y-m&&py<=en.y+en.h+m){

      if(en.kind==='worker'){
        if(en.hasHelmet){
          score=Math.max(0,score-20);
          combo=0;
          pops.push({x:px,y:py,t:0,text:'‚ùå -20',c:'#ff6b6b'});
        }else{
          const pts=en.golden?100:10+combo*2;
          score+=pts;
          combo++;
          pops.push({x:px,y:py,t:0,text:'+'+pts,c:'#7CFF9A'});
        }
      }

      if(en.kind==='dog'){
        score=Math.max(0,score-50);
        combo=0;
        pops.push({x:px,y:py,t:0,text:'üê∂ -50',c:'#ff4d4d'});
      }

      if(en.kind==='stop'){
        freezeUntil=performance.now()+2000;
        pops.push({x:px,y:py,t:0,text:'üõë FREEZE',c:'#7fd1ff'});
      }

      entities.splice(i,1);
      return;
    }
  }
});

/* ================== UPDATE ================== */
function update(dt){
  if(gameOver) return;
  timer=Math.max(0,timer-dt);
  if(timer===0){ gameOver=true; return; }

  spawnAcc+=dt*(1+Math.min(1,(60-timer)/30));
  while(spawnAcc>1){
    spawnAcc--;
    const r=Math.random();
    if(r<0.12) spawnDog();
    else if(r<0.22) spawnStop();
    else spawnWorker();
  }

  const frozen=performance.now()<freezeUntil;

  for(let i=entities.length-1;i>=0;i--){
    const e=entities[i];
    if(!frozen){
      e.x+=e.dir*e.speed*dt;
      if(e.frame!=null) e.frame+=dt*10;
    }
    if(e.x<-80||e.x>BASE_W+80){
      if(e.kind==='worker'&&!e.hasHelmet){
        score=Math.max(0,score-5);
        combo=0;
      }
      entities.splice(i,1);
    }
  }

  for(let i=pops.length-1;i>=0;i--){
    pops[i].t+=dt;
    pops[i].y-=20*dt;
    if(pops[i].t>1) pops.splice(i,1);
  }
}

/* ================== DRAW ENTITIES ================== */
function drawWorker(e){
  const flip=e.dir<0;
  const walk=Math.sin(e.frame)*3;
  const bob=Math.sin(e.frame*2);

  const px=(dx,dy,w,h,c)=>{
    const rx=flip?(e.x+e.w-(dx+w)):(e.x+dx);
    ctx.fillStyle=c;
    ctx.fillRect(rx,e.y+dy+bob,w,h);
  };

  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.fillRect(e.x+4,e.y+e.h-2,e.w-8,3);

  px(6,22+walk,6,10,'#2c5aa0');
  px(16,22-walk,6,10,'#2c5aa0');

  px(6,12,16,12,'#ffb74d');
  px(6,16,16,2,'#ff8f2a');

  px(2,14,4,8,'#ffb74d');
  px(22,14,4,8,'#ffb74d');

  px(10,4,8,8,'#d7b08a');

  if(e.hasHelmet){
    px(8,0,12,5,e.golden?'#ffe066':'#ffd24b');
    px(8,5,12,2,'#caa12b');
  }else{
    px(10,2,8,3,'#3b2a1d');
  }
}

function drawDog(e){
  ctx.fillStyle='#3a1f0f';
  ctx.fillRect(e.x,e.y+10,36,10);       // corps
  ctx.fillRect(e.x+2,e.y+6,10,8);        // t√™te
  ctx.fillRect(e.x+6,e.y+4,4,4);         // oreille
  ctx.fillRect(e.x+24,e.y+8,10,4);       // queue
  ctx.fillStyle='#000';
  ctx.fillRect(e.x+6,e.y+10,2,2);        // ≈ìil
}

function drawStop(e){
  ctx.fillStyle='#9aa3b2';
  ctx.fillRect(e.x+10,e.y+10,4,22);
  ctx.fillStyle='#e23b3b';
  ctx.fillRect(e.x,e.y,24,16);
  ctx.fillStyle='#fff';
  ctx.fillRect(e.x+4,e.y+6,16,2);
}

/* ================== DECOR ================== */
function drawDecor(){
  ctx.fillStyle='#86bdf2';
  ctx.fillRect(0,0,BASE_W,BASE_H);

  ctx.fillStyle='#5c7fa6';
  for(let i=0;i<10;i++) ctx.fillRect(20+i*32,120,20,180);

  ctx.fillStyle='#f0a93a';
  ctx.fillRect(260,120,8,300);
  ctx.fillRect(120,120,200,8);

  ctx.fillStyle='#2a2a2a';
  ctx.fillRect(200,128,2,60);
  ctx.fillRect(194,188,14,4);

  ctx.fillStyle='#c9a46b';
  ctx.fillRect(0,300,BASE_W,BASE_H);

  ctx.fillStyle='#c39a5f';
  ctx.fillRect(0,360,BASE_W,60);
  ctx.fillRect(0,420,BASE_W,60);
}

/* ================== DRAW ================== */
function draw(){
  drawDecor();

  // HUD TOP
  ctx.fillStyle='rgba(0,0,0,.6)';
  ctx.fillRect(0,0,BASE_W,30);
  ctx.fillStyle='#fff';
  ctx.font='bold 12px system-ui';
  ctx.fillText('Score '+score,10,20);
  ctx.fillText('Combo x'+Math.max(1,combo),120,20);
  ctx.fillText(Math.ceil(timer)+'s',300,20);

  entities.sort((a,b)=>a.y-b.y);
  for(const e of entities){
    if(e.kind==='worker') drawWorker(e);
    if(e.kind==='dog') drawDog(e);
    if(e.kind==='stop') drawStop(e);
  }

  // HUD BOTTOM (instructions modernes)
  ctx.fillStyle='rgba(20,20,20,.75)';
  ctx.fillRect(0,BASE_H-36,BASE_W,36);

  ctx.font='12px system-ui';
  ctx.fillStyle='#7CFF9A';
  ctx.fillText('üéØ Sans casque = + points',8,BASE_H-14);

  ctx.fillStyle='#ff4d4d';
  ctx.fillText('üê∂ Chien = -50',160,BASE_H-14);

  ctx.fillStyle='#7fd1ff';
  ctx.fillText('üõë Panneau = Freeze',260,BASE_H-14);

  // POPS
  for(const p of pops){
    ctx.globalAlpha=1-p.t;
    ctx.fillStyle=p.c;
    ctx.font='bold 14px system-ui';
    ctx.fillText(p.text,p.x,p.y);
    ctx.globalAlpha=1;
  }

  // FIN
  if(gameOver){
    ctx.fillStyle='rgba(0,0,0,0.8)';
    ctx.fillRect(0,0,BASE_W,BASE_H);

    const rank=getRank(score);
    ctx.textAlign='center';

    ctx.fillStyle='#fff';
    ctx.font='bold 28px system-ui';
    ctx.fillText('F√âLICITATIONS',BASE_W/2,160);

    ctx.font='bold 64px system-ui';
    ctx.fillStyle='#ffd24b';
    ctx.fillText(rank,BASE_W/2,250);

    ctx.font='bold 16px system-ui';
    ctx.fillStyle='#fff';
    ctx.fillText('RS-BAT TRAVAUX vous souhaite',BASE_W/2,330);
    ctx.fillText('de joyeuses f√™tes de fin d‚Äôann√©e',BASE_W/2,360);

    ctx.font='14px system-ui';
    ctx.fillStyle='#ccc';
    ctx.fillText('Score final : '+score,BASE_W/2,410);

    ctx.textAlign='left';
  }
}

/* ================== LOOP ================== */
function loop(t){
  const dt=Math.min(0.033,(t-last)/1000);
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>

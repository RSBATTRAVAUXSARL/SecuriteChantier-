<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Safety Tap â€“ Chantier Pixel</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#0b1020;
  overflow:hidden;
}
canvas{
  width:100vw;
  height:100vh;
  display:block;
  image-rendering:pixelated;
  image-rendering:crisp-edges;
  touch-action:none;
}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* ================== CANVAS ================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const BASE_W=360, BASE_H=640;
const DPR=window.devicePixelRatio||1;
canvas.width=BASE_W*DPR;
canvas.height=BASE_H*DPR;
ctx.setTransform(DPR,0,0,DPR,0,0);

/* ================== GAME STATE ================== */
let entities=[], pops=[];
let score=0, combo=0, timer=60;
let last=performance.now();
let spawnAcc=0;
let freezeUntil=0;
let gameOver=false;
let showRulesTime=6; // secondes affichage rÃ¨gles

/* ================== HELPERS ================== */
const rand=(a,b)=>a+Math.random()*(b-a);

/* ================== RANK ================== */
function getRank(s){
  if(s>=500) return 'S';
  if(s>=400) return 'A';
  if(s>=300) return 'B';
  if(s>=200) return 'C';
  if(s>=100) return 'D';
  return 'F';
}

/* ================== SPAWN ================== */
function laneY(){ return Math.random()<0.5 ? 380 : 440; }

function spawnWorker(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'worker',
    x:dir>0?-40:BASE_W+40,
    y:laneY(),
    w:28,h:36,
    dir,
    speed:rand(40,80),
    hasHelmet:Math.random()>0.4,
    golden:Math.random()<0.06,
    frame:Math.random()*Math.PI*2
  });
}

function spawnDog(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'dog',
    x:dir>0?-70:BASE_W+70,
    y:laneY()+12,
    w:48,h:26,
    dir,
    speed:120,
    frame:Math.random()*Math.PI*2
  });
}

function spawnStop(){
  const dir=Math.random()<0.5?1:-1;
  entities.push({
    kind:'stop',
    x:dir>0?-30:BASE_W+30,
    y:laneY()-40,
    w:24,h:32,
    dir,
    speed:55
  });
}

/* ================== INPUT ================== */
canvas.addEventListener('pointerdown',e=>{
  if(gameOver) return;

  const r=canvas.getBoundingClientRect();
  const px=(e.clientX-r.left)/r.width*BASE_W;
  const py=(e.clientY-r.top)/r.height*BASE_H;

  for(let i=entities.length-1;i>=0;i--){
    const en=entities[i];
    const m=14;
    if(px>=en.x-m&&px<=en.x+en.w+m&&
       py>=en.y-m&&py<=en.y+en.h+m){

      if(en.kind==='worker'){
        if(en.hasHelmet){
          score=Math.max(0,score-20);
          combo=0;
          pops.push({x:px,y:py,t:0,text:'âŒ -20',c:'#ff6b6b'});
        }else{
          const pts=en.golden?100:10+combo*2;
          score+=pts;
          combo++;
          pops.push({x:px,y:py,t:0,text:'+'+pts,c:'#7CFF9A'});
        }
      }

      if(en.kind==='dog'){
        score=Math.max(0,score-50);
        combo=0;
        pops.push({x:px,y:py,t:0,text:'ðŸ¶ -50',c:'#ff4d4d'});
      }

      if(en.kind==='stop'){
        freezeUntil=performance.now()+2000;
        pops.push({x:px,y:py,t:0,text:'ðŸ›‘ FREEZE',c:'#7fd1ff'});
      }

      entities.splice(i,1);
      return;
    }
  }
});

/* ================== UPDATE ================== */
function update(dt){
  if(gameOver) return;

  timer=Math.max(0,timer-dt);
  if(timer===0){ gameOver=true; return; }

  showRulesTime=Math.max(0,showRulesTime-dt);

  spawnAcc+=dt*(1+Math.min(1,(60-timer)/30));
  while(spawnAcc>1){
    spawnAcc--;
    const r=Math.random();
    if(r<0.15) spawnDog();
    else if(r<0.25) spawnStop();
    else spawnWorker();
  }

  const frozen=performance.now()<freezeUntil;

  for(let i=entities.length-1;i>=0;i--){
    const e=entities[i];
    if(!frozen){
      e.x+=e.dir*e.speed*dt;
      if(e.frame!=null) e.frame+=dt*12;
    }
    if(e.x<-100||e.x>BASE_W+100){
      if(e.kind==='worker'&&!e.hasHelmet){
        score=Math.max(0,score-5);
        combo=0;
      }
      entities.splice(i,1);
    }
  }

  for(let i=pops.length-1;i>=0;i--){
    pops[i].t+=dt;
    pops[i].y-=22*dt;
    if(pops[i].t>1) pops.splice(i,1);
  }
}

/* ================== DRAW ENTITIES ================== */
function drawWorker(e){
  const flip=e.dir<0;
  const walk=Math.sin(e.frame)*3;
  const bob=Math.sin(e.frame*2);

  const px=(dx,dy,w,h,c)=>{
    const rx=flip?(e.x+e.w-(dx+w)):(e.x+dx);
    ctx.fillStyle=c;
    ctx.fillRect(rx,e.y+dy+bob,w,h);
  };

  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.fillRect(e.x+4,e.y+e.h-2,e.w-8,3);

  px(6,22+walk,6,10,'#2c5aa0');
  px(16,22-walk,6,10,'#2c5aa0');

  px(6,12,16,12,'#ffb74d');
  px(6,16,16,2,'#ff8f2a');

  px(2,14,4,8,'#ffb74d');
  px(22,14,4,8,'#ffb74d');

  px(10,4,8,8,'#d7b08a');

  if(e.hasHelmet){
    px(8,0,12,5,e.golden?'#ffe066':'#ffd24b');
    px(8,5,12,2,'#caa12b');
  }else{
    px(10,2,8,3,'#3b2a1d');
  }
}

function drawDog(e){
  const flip=e.dir<0;
  const t=e.frame;
  const bob=Math.sin(t*2)*1;
  const leg=Math.sin(t)>0?1:0;

  const px=(dx,dy,w,h,c)=>{
    const rx=flip?(e.x+e.w-(dx+w)):(e.x+dx);
    ctx.fillStyle=c;
    ctx.fillRect(rx,e.y+dy+bob,w,h);
  };

  // ombre
  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.fillRect(e.x+8,e.y+e.h-2,e.w-16,3);

  // corps
  px(14,12,24,8,'#4b2614');

  // tÃªte + museau
  px(6,10,10,10,'#5c2e16');
  px(2,12,6,6,'#2a140a');
  px(6,14,2,2,'#000');

  // oreille
  px(10,8,4,4,'#2a140a');

  // queue
  px(38,12,6,3,'#2a140a');

  // pattes (4)
  px(14,20,4,4,'#2a140a');
  px(20,20,4,4,'#2a140a');
  px(28,20,4,4,'#2a140a');
  px(34,20,4,4,'#2a140a');

  // animation pattes
  if(leg){
    px(14,19,4,4,'#2a140a');
    px(28,19,4,4,'#2a140a');
  }else{
    px(20,19,4,4,'#2a140a');
    px(34,19,4,4,'#2a140a');
  }
}

function drawStop(e){
  ctx.fillStyle='#9aa3b2';
  ctx.fillRect(e.x+10,e.y+10,4,22);
  ctx.fillStyle='#e23b3b';
  ctx.fillRect(e.x,e.y,24,16);
  ctx.fillStyle='#fff';
  ctx.fillRect(e.x+4,e.y+6,16,2);
}

/* ================== DECOR ================== */
function drawDecor(){
  ctx.fillStyle='#86bdf2';
  ctx.fillRect(0,0,BASE_W,BASE_H);

  ctx.fillStyle='#5c7fa6';
  for(let i=0;i<10;i++) ctx.fillRect(20+i*32,120,20,180);

  ctx.fillStyle='#f0a93a';
  ctx.fillRect(260,120,8,300);
  ctx.fillRect(120,120,200,8);

  ctx.fillStyle='#2a2a2a';
  ctx.fillRect(200,128,2,60);
  ctx.fillRect(194,188,14,4);

  ctx.fillStyle='#c9a46b';
  ctx.fillRect(0,300,BASE_W,BASE_H);
  ctx.fillStyle='#c39a5f';
  ctx.fillRect(0,360,BASE_W,60);
  ctx.fillRect(0,420,BASE_W,60);
}

/* ================== DRAW ================== */
function draw(){
  drawDecor();

  // HUD TOP
  ctx.fillStyle='rgba(0,0,0,.6)';
  ctx.fillRect(0,0,BASE_W,30);
  ctx.fillStyle='#fff';
  ctx.font='bold 12px system-ui';
  ctx.fillText('Score '+score,10,20);
  ctx.fillText('Combo x'+Math.max(1,combo),120,20);
  ctx.fillText(Math.ceil(timer)+'s',300,20);

  // RÃˆGLES BLEUES
  if(showRulesTime>0){
    ctx.fillStyle='rgba(40,120,255,.85)';
    ctx.fillRect(10,36,340,56);
    ctx.fillStyle='#fff';
    ctx.font='12px system-ui';
    ctx.fillText('ðŸŽ¯ Tape les ouvriers SANS casque = points',20,56);
    ctx.fillText('ðŸ¶ Le chien = -50 points',20,72);
    ctx.fillText('ðŸ›‘ Panneau = gÃ¨le le chantier',20,88);
  }

  entities.sort((a,b)=>a.y-b.y);
  for(const e of entities){
    if(e.kind==='worker') drawWorker(e);
    if(e.kind==='dog') drawDog(e);
    if(e.kind==='stop') drawStop(e);
  }

  for(const p of pops){
    ctx.globalAlpha=1-p.t;
    ctx.fillStyle=p.c;
    ctx.font='bold 14px system-ui';
    ctx.fillText(p.text,p.x,p.y);
    ctx.globalAlpha=1;
  }

  if(gameOver){
    ctx.fillStyle='rgba(0,0,0,.8)';
    ctx.fillRect(0,0,BASE_W,BASE_H);

    const rank=getRank(score);
    ctx.textAlign='center';
    ctx.fillStyle='#fff';
    ctx.font='bold 28px system-ui';
    ctx.fillText('FÃ‰LICITATIONS',BASE_W/2,160);

    ctx.font='bold 64px system-ui';
    ctx.fillStyle='#ffd24b';
    ctx.fillText(rank,BASE_W/2,250);

    ctx.font='bold 16px system-ui';
    ctx.fillStyle='#fff';
    ctx.fillText('RS-BAT TRAVAUX vous souhaite',BASE_W/2,330);
    ctx.fillText('de joyeuses fÃªtes de fin dâ€™annÃ©e',BASE_W/2,360);

    ctx.font='14px system-ui';
    ctx.fillStyle='#ccc';
    ctx.fillText('Score final : '+score,BASE_W/2,410);
    ctx.textAlign='left';
  }
}

/* ================== LOOP ================== */
function loop(t){
  const dt=Math.min(0.033,(t-last)/1000);
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
